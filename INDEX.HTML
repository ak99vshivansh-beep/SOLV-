<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOLV? - Dungeon of Improvement</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Dark, dungeon-like background */
            @apply bg-gray-900 text-gray-100;
        }
        .section-content {
            display: none; /* Hidden by default */
        }
        .section-content.active {
            display: block; /* Shown when active */
        }
        /* Custom scrollbar for individual blog posts and comment section */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: #4b5563; /* Tailwind gray-600 */
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #9ca3af; /* Tailwind gray-400 */
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Tailwind gray-500 */
        }
        .nav-button {
            @apply px-6 py-3 rounded-full font-semibold text-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 bg-gray-700 text-gray-100 hover:bg-gray-600 focus:ring-amber-500;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Header - Dungeon Entrance -->
    <header class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-6 shadow-lg rounded-b-xl border-b-2 border-amber-600">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-4 md:mb-0 text-amber-300">
                <span class="block">SOLV?</span>
                <span class="text-xl md:text-2xl font-normal opacity-90 text-amber-200">The Dungeon of Improvement</span>
            </h1>
            <nav class="space-x-4">
                <button class="nav-button" data-section="health">Health Chamber</button>
                <button class="nav-button" data-section="diet">Diet Scrolls</button>
                <button class="nav-button" data-section="pollution">Pollution Puzzles</button>
                <button class="nav-button" data-section="insights">Insight Altar</button>
            </nav>
        </div>
    </header>

    <!-- Main Content Area - Dungeon Halls -->
    <main class="container mx-auto p-6 flex-grow">
        <!-- Health Section - Health Chamber -->
        <section id="health-section" class="section-content active bg-gray-800 p-8 rounded-lg shadow-xl mb-8 border border-amber-500">
            <h2 class="text-3xl font-semibold text-amber-400 mb-6 border-b-2 border-amber-700 pb-3">Essential Health Potions & Charms</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-emerald-300 mb-3">Enchant Your Movement</h3>
                    <p class="text-gray-200">Forge your body with at least 150 minutes of moderate activity each week. Traverse through brisk walks, lively dances, or spirited cycles. Even small journeys count!</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-emerald-300 mb-3">The Slumbering Sanctuary</h3>
                    <p class="text-gray-200">Seek 7-9 hours of peaceful sleep in your sanctuary each night. Rest is the magical elixir for body and mind, restoring your inner strength.</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-emerald-300 mb-3">Tame the Stress Beasts</h3>
                    <p class="text-gray-200">Master stress with spells of mindfulness, meditation, or engaging in joyful quests. Unchecked stress can drain your life force!</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-emerald-300 mb-3">Elixir of Hydration</h3>
                    <p class="text-gray-200">Drink ample amounts of pure water throughout your day. This vital elixir fuels all your bodily enchantments and purifies your essence.</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-emerald-300 mb-3">Scribe Your Health Runes</h3>
                    <p class="text-gray-200">Keep up with your annual check-ups, eye, and dental inspections. Early divination of health challenges is a wise strategy for any adventurer.</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-emerald-300 mb-3">Cleanse the Smoke Curse</h3>
                    <p class="text-gray-200">If you carry the smoke curse, casting it off is the greatest boon to your vitality. Seek guidance from wise healers for this important quest.</p>
                </div>
            </div>
        </section>

        <!-- Diet Section - Diet Scrolls -->
        <section id="diet-section" class="section-content bg-gray-800 p-8 rounded-lg shadow-xl mb-8 border border-amber-500">
            <h2 class="text-3xl font-semibold text-amber-400 mb-6 border-b-2 border-amber-700 pb-3">Diet Scrolls: Nourishing Your Adventurer</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-lime-300 mb-3">Feast on Nature's Bounty</h3>
                    <p class="text-gray-200">Fill your plate with a vibrant spectrum of fruits and vegetables daily. They are nature's hidden treasures, bursting with vitamins and minerals!</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-lime-300 mb-3">The Grains of Wisdom</h3>
                    <p class="text-gray-200">Choose whole grains like brown rice and whole-wheat bread. These ancient grains provide steady energy for your epic journeys, unlike refined choices!</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-lime-300 mb-3">Strength from Lean Provisions</h3>
                    <p class="text-gray-200">Seek lean proteins like fish, beans, and nuts. And don't forget the healthy oils, like liquid gold from olives, for well-oiled adventuring!</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-lime-300 mb-3">Banish Processed Blight</h3>
                    <p class="text-gray-200">Limit processed foods and sugary potions. They are often traps, leading to weakened defenses and hindering your progress.</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-lime-300 mb-3">Master Your Portions</h3>
                    <p class="text-gray-200">Control the size of your feasts to maintain a balanced strength. Eat mindfully, savoring each bite of your nourishing provisions.</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-lime-300 mb-3">Embrace the Mediterranean Lore</h3>
                    <p class="text-gray-200">Follow the ancient Mediterranean wisdom: focus on plants, healthy fats, and fish. Reduce red meat and sugary delights for optimal vitality.</p>
                </div>
            </div>
        </section>

        <!-- Air Pollution Section - Pollution Puzzles -->
        <section id="pollution-section" class="section-content bg-gray-800 p-8 rounded-lg shadow-xl mb-8 border border-amber-500">
            <h2 class="text-3xl font-semibold text-amber-400 mb-6 border-b-2 border-amber-700 pb-3">Pollution Puzzles: Defending Your Air</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-teal-300 mb-3">Scry the Air Quality</h3>
                    <p class="text-gray-200">Consult the daily AQI scrolls for your realm. When the air is thick with shadows, limit your outdoor quests, especially if you're vulnerable.</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-teal-300 mb-3">Indoor Air Sentinels</h3>
                    <p class="text-gray-200">Deploy a powerful air purifier with a HEPA filter within your abode. It will stand guard, cleansing the air you breathe in your sanctuary.</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-teal-300 mb-3">The Mask of Protection</h3>
                    <p class="text-gray-200">When the air is heavy with pollutants, don an N95 or N99 mask. It's a crucial artifact to shield your lungs from unseen dangers.</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-teal-300 mb-3">Dietary Shields</h3>
                    <p class="text-gray-200">Feast on antioxidant-rich foods like berries, citrus, and leafy greens. These magical edibles boost your body's defenses against pollution's ill effects.</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-teal-300 mb-3">Living Air Fresheners</h3>
                    <p class="text-gray-200">Invite indoor plants like Snake Plants or Peace Lilies into your dwelling. They are natural air-purifying companions on your quest for clean air.</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-gray-600">
                    <h3 class="text-xl font-medium text-teal-300 mb-3">Reduce Your Shadow</h3>
                    <p class="text-gray-200">Lessen your impact: walk, bike, or share rides. Avoid burning ancient wood or refuse, and choose electric tools for your outdoor tasks.</p>
                </div>
            </div>
        </section>

        <!-- Daily Insights Section - Insight Altar -->
        <section id="insights-section" class="section-content bg-gray-800 p-8 rounded-lg shadow-xl mb-8 border border-amber-500">
            <h2 class="text-3xl font-semibold text-amber-400 mb-6 border-b-2 border-amber-700 pb-3">Insight Altar: Wisdom & Reflections</h2>

            <!-- AI Tip Generator -->
            <div class="bg-gray-700 p-6 rounded-md shadow-md mb-8 border border-amber-600">
                <h3 class="text-xl font-semibold text-amber-300 mb-4">✨ Consult the Oracle of Tips!</h3>
                <textarea id="ai-prompt-input" class="w-full p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-4 bg-gray-900 text-gray-100" rows="3" placeholder="e.g., 'Give me a health tip about sleep', 'Suggest a healthy snack', 'What's one way to reduce car pollution?'"></textarea>
                <button id="generate-tip-button" class="px-6 py-3 bg-amber-600 text-white rounded-full font-semibold text-lg transition duration-300 ease-in-out transform hover:scale-105 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-500">Summon Wisdom</button>
                <div id="ai-response-area" class="mt-6 p-4 bg-gray-900 rounded-md border border-amber-700 text-gray-200 leading-relaxed min-h-[50px]">
                    <p class="text-gray-400">Your Oracle's wisdom will appear here!</p>
                </div>
                <div id="loading-indicator" class="mt-4 text-center text-amber-500 font-medium hidden">Oracle is pondering...</div>
            </div>

            <div class="space-y-8 mb-8">
                <!-- Sample Blog Post 1 -->
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-amber-600">
                    <h3 class="text-2xl font-semibold text-amber-300 mb-2">🌿 Small Steps for a Cleaner Planet</h3>
                    <p class="text-sm text-gray-400 mb-4">July 28, 2025 | Environmental Focus</p>
                    <div class="scrollable-content text-gray-200 leading-relaxed max-h-48 overflow-y-auto pr-2">
                        <p class="mb-3">Did you know that even small changes in your daily routine can make a big difference for the environment? Today, let's talk about **reducing plastic waste**. Single-use plastics like straws, bags, and water bottles often end up in our oceans and landfills, harming wildlife and polluting our planet.</p>
                        <p class="mb-3">**What you can do today:**</p>
                        <ul class="list-disc list-inside mb-3 ml-4">
                            <li>Carry a reusable water bottle.</li>
                            <li>Bring your own shopping bag to stores.</li>
                            <li>Say "no thanks" to plastic straws at restaurants.</li>
                        </ul>
                        <p>These simple actions help protect our beautiful Earth. Every bit counts!</p>
                        <p>Let's make a commitment to reduce our plastic footprint together!</p>
                    </div>
                </div>

                <!-- Sample Blog Post 2 -->
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-amber-600">
                    <h3 class="text-2xl font-semibold text-amber-300 mb-2">🍎 Power Up Your Immune System with Fruits!</h3>
                    <p class="text-sm text-gray-400 mb-4">July 27, 2025 | Health & Diet Focus</p>
                    <div class="scrollable-content text-gray-200 leading-relaxed max-h-48 overflow-y-auto pr-2">
                        <p class="mb-3">When air pollution is a concern, it's super important to keep your body strong from the inside out. One amazing way to do this is by eating plenty of fruits, especially those packed with **Vitamin C**!</p>
                        <p class="mb-3">Vitamin C is a powerful antioxidant that helps protect your cells from damage caused by pollution. It also gives your immune system a big boost!</p>
                        <p class="mb-3">**Today's Fruity Challenge:** Try to include one of these Vitamin C powerhouses in your snacks or meals:</p>
                        <ul class="list-disc list-inside mb-3 ml-4">
                            <li>Oranges 🍊</li>
                            <li>Strawberries 🍓</li>
                            <li>Kiwi 🥝</li>
                            <li>Bell Peppers (yes, they're fruits botanically!) 🫑</li>
                            <li>Guava (super high in Vitamin C!)</li>
                        </ul>
                        <p>Eating colorful fruits and veggies is like building a shield for your body against bad stuff in the air. Stay healthy and happy!</p>
                    </div>
                </div>

                <!-- Sample Blog Post 3 -->
                <div class="bg-gray-700 p-6 rounded-md shadow-md hover:shadow-lg transition-shadow duration-300 border border-amber-600">
                    <h3 class="text-2xl font-semibold text-amber-300 mb-2">💨 Understanding AQI: What You Need to Know</h3>
                    <p class="text-sm text-gray-400 mb-4">July 26, 2025 | Pollution Focus</p>
                    <div class="scrollable-content text-gray-200 leading-relaxed max-h-48 overflow-y-auto pr-2">
                        <p class="mb-3">Have you ever heard of the **AQI (Air Quality Index)**? It's like a weather report for the air! The AQI tells us how clean or polluted the air is and what health effects you might experience within a few hours or days after breathing it.</p>
                        <p class="mb-3">Different colors and numbers mean different things:</p>
                        <ul class="list-disc list-inside mb-3 ml-4">
                            <li>**Green (0-50):** Good air quality. Great for outdoor activities!</li>
                            <li>**Yellow (51-100):** Moderate air quality. Most people are fine, but very sensitive people might consider reducing prolonged outdoor exertion.</li>
                            <li>**Orange (101-150):** Unhealthy for sensitive groups. If you have asthma or other breathing issues, be careful outdoors.</li>
                            <li>**Red (151-200):** Unhealthy. Everyone might start to experience health effects. Limit outdoor activities.</li>
                            <li>**Purple (201-300):** Very Unhealthy. Avoid all outdoor physical activity.</li>
                            <li>**Maroon (301+):** Hazardous. Emergency conditions, stay indoors.</li>
                        </ul>
                        <p>You can often find the AQI on weather apps or dedicated air quality websites. Knowing the AQI helps you make smart choices about spending time outdoors and protecting your lungs!</p>
                    </div>
                </div>
            </div>

            ---

            <!-- Comment Section - Scribe's Ledger -->
            <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-amber-600">
                <h3 class="text-2xl font-semibold text-amber-300 mb-4 border-b-2 border-amber-700 pb-2">Scribe Your Thoughts in the Ledger</h3>
                <div id="user-id-display" class="text-sm text-gray-400 mb-4">Your Anonymous Scribe ID: Loading...</div>
                <textarea id="comment-input" class="w-full p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-4 bg-gray-900 text-gray-100" rows="4" placeholder="Share your wisdom or ask a question..."></textarea>
                <button id="post-comment-button" class="px-6 py-3 bg-amber-600 text-white rounded-full font-semibold text-lg transition duration-300 ease-in-out transform hover:scale-105 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-500">Record Insight</button>
                <div id="comment-status" class="mt-4 text-sm text-gray-400 hidden"></div>

                <div class="mt-8">
                    <h4 class="text-xl font-semibold text-amber-300 mb-4">Echoes of Wisdom:</h4>
                    <div id="comments-list" class="space-y-4 scrollable-content max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-400">No comments yet. Be the first to share your wisdom!</p>
                        <!-- Comments will be loaded here -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer - Dungeon Depths -->
    <footer class="bg-gray-950 text-gray-500 p-6 mt-8 rounded-t-xl shadow-inner border-t-2 border-amber-900">
        <div class="container mx-auto text-center text-sm opacity-80">
            <p>&copy; 2025 SOLV?. All rights reserved.</p>
            <p>Disclaimer: This information is for general guidance and not a substitute for professional medical advice.</p>
        </div>
    </footer>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const navButtons = document.querySelectorAll('.nav-button');
            const sections = document.querySelectorAll('.section-content');
            const generateTipButton = document.getElementById('generate-tip-button');
            const aiPromptInput = document.getElementById('ai-prompt-input');
            const aiResponseArea = document.getElementById('ai-response-area');
            const loadingIndicator = document.getElementById('loading-indicator');

            const commentInput = document.getElementById('comment-input');
            const postCommentButton = document.getElementById('post-comment-button');
            const commentsList = document.getElementById('comments-list');
            const commentStatus = document.getElementById('comment-status');
            const userIdDisplay = document.getElementById('user-id-display');

            // --- Firebase Initialization ---
            let db;
            let auth;
            let userId = 'anonymous'; // Default to anonymous
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Provided by Canvas environment
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {}; // Provided by Canvas environment

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate anonymously or with custom token
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `Your Scribe ID: ${userId}`;
                        console.log("Firebase initialized. User ID:", userId);
                        // Start listening for comments only after auth is ready
                        setupCommentListener();
                    } else {
                        userId = 'anonymous';
                        userIdDisplay.textContent = `Your Scribe ID: Not logged in (anonymous)`;
                        console.log("No user signed in. Using anonymous ID.");
                    }
                });

            } catch (firebaseError) {
                console.error("Firebase initialization failed:", firebaseError);
                userIdDisplay.textContent = `Firebase Error: Cannot connect to ledger.`;
                commentStatus.textContent = `Error: Cannot connect to ledger. Check console.`;
                commentStatus.classList.remove('hidden');
            }


            // Function to show a specific section
            const showSection = (sectionId) => {
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(`${sectionId}-section`).classList.add('active');
            };

            // Add click event listeners to navigation buttons
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showSection(button.dataset.section);
                });
            });

            // Initially show the health section
            showSection('health');


            // --- AI Integration Logic ---

            // Function to make API call with exponential backoff
            async function callGeminiAPIWithBackoff(prompt, retries = 3, delay = 1000) {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                };
                // The API key is automatically provided by the Canvas runtime. No user action is needed here.
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`; // Using gemini-1.5-flash

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP error! Status: ${response.status}. Details: ${errorText}`);
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error("Unexpected API response structure.");
                        }
                    } catch (error) {
                        if (i < retries - 1) {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                        } else {
                            throw error;
                        }
                    }
                }
                throw new Error("Failed to get response after multiple retries.");
            }

            // Event listener for the AI tip generation button
            generateTipButton.addEventListener('click', async () => {
                const userPrompt = aiPromptInput.value.trim();

                if (!userPrompt) {
                    aiResponseArea.innerHTML = '<p class="text-red-400">Please enter a prompt for the Oracle!</p>';
                    return;
                }

                aiResponseArea.innerHTML = '';
                loadingIndicator.classList.remove('hidden');
                generateTipButton.disabled = true;

                try {
                    const fullPrompt = `You are a helpful assistant providing health, diet, and air pollution tips. As the user is under 18, keep your response simple, safe, positive, and age-appropriate. Avoid complex medical terms or anything unsuitable for younger audiences. Based on the user's request: "${userPrompt}", provide a concise, friendly tip.`;
                    const aiTip = await callGeminiAPIWithBackoff(fullPrompt);
                    aiResponseArea.innerHTML = `<p>${aiTip}</p>`;
                } catch (error) {
                    console.error("Error generating AI tip:", error);
                    let errorMessage = 'Oops! The Oracle is currently silent. Try again later.';
                    if (error.message.includes('Network') || error.message.includes('Failed to fetch')) {
                         errorMessage = 'Cannot consult the Oracle. Check your connection to the realm!';
                    } else if (error.message.includes('HTTP error') || error.message.includes('Unexpected API response')) {
                        errorMessage = 'The Oracle is pondering too deeply. Please try summoning wisdom again soon!';
                    }
                    aiResponseArea.innerHTML = `<p class="text-red-400">${errorMessage}</p>`;
                } finally {
                    loadingIndicator.classList.add('hidden');
                    generateTipButton.disabled = false;
                }
            });


            // --- Comment Section Logic ---

            // Function to set up the real-time listener for comments
            const setupCommentListener = () => {
                if (!db) {
                    console.error("Firestore not initialized for comments.");
                    return;
                }
                const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/comments`);
                const q = query(commentsCollectionRef); // No orderBy here to avoid index requirements

                onSnapshot(q, (snapshot) => {
                    commentsList.innerHTML = ''; // Clear existing comments
                    if (snapshot.empty) {
                        commentsList.innerHTML = '<p class="text-gray-400">No echoes of wisdom yet. Be the first to share!</p>';
                        return;
                    }
                    snapshot.forEach((doc) => {
                        const commentData = doc.data();
                        const commentElement = document.createElement('div');
                        commentElement.className = 'bg-gray-800 p-4 rounded-md border border-gray-600 shadow-sm';

                        // Format timestamp if available, otherwise default
                        const timestamp = commentData.timestamp ?
                            new Date(commentData.timestamp.toDate()).toLocaleString() :
                            'Unknown time';

                        commentElement.innerHTML = `
                            <p class="text-gray-200 mb-2">${commentData.text}</p>
                            <p class="text-xs text-gray-400">Scribe: ${commentData.userId || 'Anonymous'} <span class="ml-2">| ${timestamp}</span></p>
                        `;
                        commentsList.appendChild(commentElement);
                    });
                }, (error) => {
                    console.error("Error listening to comments:", error);
                    commentsList.innerHTML = `<p class="text-red-400">Failed to retrieve echoes of wisdom: ${error.message}</p>`;
                });
            };

            // Event listener for posting comments
            postCommentButton.addEventListener('click', async () => {
                const commentText = commentInput.value.trim();

                if (!commentText) {
                    commentStatus.textContent = "Please scribe some wisdom before recording!";
                    commentStatus.classList.remove('hidden');
                    commentStatus.classList.add('text-red-400');
                    return;
                }

                commentStatus.classList.add('hidden'); // Hide previous status
                commentStatus.classList.remove('text-red-400', 'text-emerald-400');
                postCommentButton.disabled = true;

                try {
                    // Ensure Firebase is initialized before attempting to write
                    if (!db || !auth.currentUser) {
                        throw new Error("Dungeon's ledger is not ready. Please wait or refresh.");
                    }

                    await addDoc(collection(db, `artifacts/${appId}/public/data/comments`), {
                        userId: auth.currentUser.uid, // Use the authenticated user's ID
                        text: commentText,
                        timestamp: serverTimestamp() // Firestore's server timestamp
                    });
                    commentInput.value = ''; // Clear input field
                    commentStatus.textContent = "Your wisdom is recorded in the ledger!";
                    commentStatus.classList.remove('hidden');
                    commentStatus.classList.add('text-emerald-400');
                } catch (error) {
                    console.error("Error posting comment:", error);
                    commentStatus.textContent = `Failed to record wisdom: ${error.message}.`;
                    commentStatus.classList.remove('hidden');
                    commentStatus.classList.add('text-red-400');
                } finally {
                    postCommentButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
